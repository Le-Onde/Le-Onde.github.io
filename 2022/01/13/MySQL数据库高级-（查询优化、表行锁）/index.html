

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/newcon.png">
  <link rel="icon" href="/img/newfav.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
  <title>MySQL数据库高级 - （查询优化、表行锁） - Hexo</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.9","typing":{"enable":true,"typeSpeed":64,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Le Onde</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                主页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                种类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('https://img-blog.csdnimg.cn/20210421122657715.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NzYxMzEwNQ==,size_16,color_FFFFFF,t_70') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="MySQL数据库高级 - （查询优化、表行锁）">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-01-13 22:21" pubdate>
        January 13, 2022 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      7.6k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      106
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">MySQL数据库高级 - （查询优化、表行锁）</h1>
            
            <div class="markdown-body">
              <h2 id="查询优化"><a href="#查询优化" class="headerlink" title="查询优化"></a>查询优化</h2><h3 id="1-小表驱动大表"><a href="#1-小表驱动大表" class="headerlink" title="1.小表驱动大表"></a>1.小表驱动大表</h3><p>优化原则：对于MySQL数据库而言， <strong>永远都是小表驱动大表</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs MySQL">&#x2F;**<br>* 举个例子：可以使用嵌套的for循环来理解小表驱动大表。<br>* 以下两个循环结果都是一样的，但是对于MySQL来说不一样，<br>* 第一种可以理解为，和MySQL建立5次连接每次查询1000次。<br>* 第一种可以理解为，和MySQL建立1000次连接每次查询5次。<br>*&#x2F;<br>for(int i &#x3D; 1; i &lt;&#x3D; 5; i ++)&#123;<br>    for(int j &#x3D; 1; j &lt;&#x3D; 1000; j++)&#123;<br>        <br>    &#125;<br>&#125;<br>&#x2F;&#x2F; ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~<br>for(int i &#x3D; 1; i &lt;&#x3D; 1000; i ++)&#123;<br>    for(int j &#x3D; 1; j &lt;&#x3D; 5; j++)&#123;<br>        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>IN和EXISTS</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs MYSQL">#优化原则：小表驱动大表，即小的数据集驱动大的数据集<br><br>#IN适合B表比A表数据小的情况<br>SELECT * FROM A WHERE id IN (SELECT id FROM B)<br>#等价于<br>for SELECT id FROM B<br>for SELECT * FROM A WHERE A.id &#x3D; B.id<br><br>#EXISTS适合B表比A表数据大的情况<br>SELECT * FROM A WHERE EXISTS (SELECT 1 FROM B WHERE B.id &#x3D; A.id);<br>#等价于<br>for SELECT * FROM A <br>for SELECT * FROM B WHERE B.id &#x3D; A.id<br></code></pre></td></tr></table></figure>

<p><strong>EXISTS：</strong></p>
<ul>
<li><p>语法：<code>SELECT...FROM tab WHERE EXISTS(subquery);</code>该语法可以理解为：</p>
<p>该语法可以理解为：将主查询的数据，放到子查询中做条件验证，根据验证结果（<code>true</code>或是<code>false</code>）来决定主查询的数据结果是否得以保留。</p>
</li>
</ul>
<p><strong>提示：</strong></p>
<ul>
<li><code>EXISTS(subquery)</code>子查询只返回<code>true</code>或者<code>false</code>，因此子查询中的<code>SELECT *</code>可以是<code>SELECT 1 OR SELECT X</code>，它们并没有区别。</li>
<li><code>EXISTS(subquery)</code>子查询的实际执行过程可能经过了优化而不是我们理解上的逐条对比，如果担心效率问题，可进行实际检验以确定是否有效率问题。</li>
<li><code>EXISTS(subquery)</code>子查询往往也可以用条件表达式，其他子查询或者<code>JOIN</code>替代，何种最优需要具体问题具体分析。</li>
</ul>
<h3 id="2-ORDER-BY优化"><a href="#2-ORDER-BY优化" class="headerlink" title="2.ORDER BY优化"></a>2.ORDER BY优化</h3><p><strong>数据准备</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE TABLE &#96;talA&#96;(<br> id integer primary key auto_increment,<br>&#96;age&#96; INT,<br>&#96;birth&#96; TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP<br>);<br><br>INSERT INTO &#96;talA&#96;(&#96;age&#96;) VALUES(18);<br>INSERT INTO &#96;talA&#96;(&#96;age&#96;) VALUES(19);<br>INSERT INTO &#96;talA&#96;(&#96;age&#96;) VALUES(20);<br>INSERT INTO &#96;talA&#96;(&#96;age&#96;) VALUES(21);<br>INSERT INTO &#96;talA&#96;(&#96;age&#96;) VALUES(22);<br>INSERT INTO &#96;talA&#96;(&#96;age&#96;) VALUES(23);<br>INSERT INTO &#96;talA&#96;(&#96;age&#96;) VALUES(24);<br>INSERT INTO &#96;talA&#96;(&#96;age&#96;) VALUES(25);<br><br>&#x2F;* 创建索引 *&#x2F;<br>CREATE INDEX idx_talA_age_birth ON &#96;talA&#96;(&#96;age&#96;, &#96;birth&#96;);<br></code></pre></td></tr></table></figure>

<p><strong>案例</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs mysql">&#x2F;* 1.使用索引进行排序了 不会产生Using filesort *&#x2F;<br>EXPLAIN SELECT * FROM &#96;talA&#96; WHERE &#96;age&#96; &gt; 20 ORDER BY &#96;age&#96;;<br><br>&#x2F;* 2.使用索引进行排序了 不会产生Using filesort *&#x2F;<br>EXPLAIN SELECT * FROM &#96;talA&#96; WHERE &#96;age&#96; &gt; 20 ORDER BY &#96;age&#96;,&#96;birth&#96;;<br><br>&#x2F;* 3.没有使用索引进行排序 产生了Using filesort *&#x2F;<br>EXPLAIN SELECT * FROM &#96;talA&#96; WHERE &#96;age&#96; &gt; 20 ORDER BY &#96;birth&#96;;<br><br>&#x2F;* 4.没有使用索引进行排序 产生了Using filesort *&#x2F;<br>EXPLAIN SELECT * FROM &#96;talA&#96; WHERE &#96;age&#96; &gt; 20 ORDER BY &#96;birth&#96;,&#96;age&#96;;<br><br>&#x2F;* 5.没有使用索引进行排序 产生了Using filesort *&#x2F;<br>EXPLAIN SELECT * FROM &#96;talA&#96; ORDER BY &#96;birth&#96;;<br><br>&#x2F;* 6.没有使用索引进行排序 产生了Using filesort *&#x2F;<br>EXPLAIN SELECT * FROM &#96;talA&#96; WHERE &#96;birth&#96; &gt; &#39;2020-08-04 07:42:21&#39; ORDER BY &#96;birth&#96;;<br><br>&#x2F;* 7.使用索引进行排序了 不会产生Using filesort *&#x2F;<br>EXPLAIN SELECT * FROM &#96;talA&#96; WHERE &#96;birth&#96; &gt; &#39;2020-08-04 07:42:21&#39; ORDER BY &#96;age&#96;;<br><br>&#x2F;* 8.没有使用索引进行排序 产生了Using filesort *&#x2F;<br>EXPLAIN SELECT * FROM &#96;talA&#96; ORDER BY &#96;age&#96; ASC, &#96;birth&#96; DESC;<br></code></pre></td></tr></table></figure>

<p><code>ORDER BY</code>子句，尽量使用索引排序，避免使用<code>Using filesort</code>排序。</p>
<p>MySQL支持两种方式的排序，<code>FileSort</code>和<code>Index</code>，<code>Index</code>的效率高，它指MySQL扫描索引本身完成排序。<code>FileSort</code>方式效率较低。</p>
<p><code>ORDER BY</code>满足两情况，会使用<code>Index</code>方式排序</p>
<ul>
<li><code>ORDER BY</code><strong>语句使用索引最左前列。</strong></li>
<li><strong>使用</strong><code>**WHERE**</code><strong>子句与</strong><code>**ORDER BY**</code><strong>子句条件列组合满足索引最左前列。</strong></li>
</ul>
<p><strong>结论：尽可能在索引列上完成排序操作，遵照索引建的最佳左前缀原则。</strong></p>
<p>如果不在索引列上，File Sort有两种算法：MySQL就要启动双路排序算法和单路排序算法</p>
<ol>
<li><p><strong>双路排序算法：</strong>MySQL4.1之前使用双路排序，字面意思就是两次扫描磁盘，最终得到数据，读取行指针和<code>ORDER BY</code>列，対他们进行排序，然后扫描已经排序好的列表，按照列表中的值重新从列表中读取对应的数据输出。<strong>一句话，从磁盘取排序字段，在<code>buffer</code>中进行排序，再从磁盘取其他字段。</strong></p>
<p>取一批数据，要对磁盘进行两次扫描，众所周知，IO是很耗时的，所以在MySQL4.1之后，出现了改进的算法，就是单路排序算法</p>
</li>
<li><p><strong>单路排序算法：</strong>从磁盘读取查询需要的所有列，按照<code>ORDER BY</code>列在<code>buffer</code>対它们进行排序，然后扫描排序后的列表进行输出，它的效率更快一些，避免了第二次读取数据。并且把随机IO变成了顺序IO，但是它会使用更多的空间，因为它把每一行都保存在内存中了。</p>
<p>由于单路排序算法是后出的，总体而言效率好过双路排序算法。</p>
<p>但是单路排序算法有问题：如果<code>SortBuffer</code>缓冲区太小，导致从磁盘中读取所有的列不能完全保存在<code>SortBuffer</code>缓冲区中，这时候单路复用算法就会出现问题，反而性能不如双路复用算法。</p>
</li>
</ol>
<p><strong>单路复用算法的优化策略：</strong></p>
<ul>
<li>增大<code>sort_buffer_size</code>参数的设置。</li>
<li>增大<code>max_length_for_sort_data</code>参数的设置。</li>
</ul>
<p><strong>提高ORDER BY排序的速度：</strong></p>
<ul>
<li><code>ORDER BY</code>时使用<code>SELECT *</code>是大忌，查什么字段就写什么字段，这点非常重要。在这里的影响是： <ul>
<li>当查询的字段大小总和小于<code>max_length_for_sort_data</code>而且排序字段不是<code>TEXT|BLOB</code>类型时，会使用单路排序算法，否则使用多路排序算法。</li>
<li>两种排序算法的数据都有可能超出<code>sort_buffer</code>缓冲区的容量，超出之后，会创建<code>tmp</code>临时文件进行合并排序，导致多次IO，但是单路排序算法的风险会更大一些，所以要增大<code>sort_buffer_size</code>参数的设置。</li>
</ul>
</li>
<li>尝试提高<code>sort_buffer_size</code>：不管使用哪种算法，提高这个参数都会提高效率，当然，要根据系统的能力去提高，因为这个参数是针对每个进程的。 </li>
<li>尝试提高<code>max_length_for_sort_data</code>：提高这个参数，会增加用单路排序算法的概率。但是如果设置的太高，数据总容量<code>sort_buffer_size</code>的概率就增大，明显症状是高的磁盘IO活动和低的处理器使用率。 </li>
</ul>
<h3 id="3-GROUP-BY优化"><a href="#3-GROUP-BY优化" class="headerlink" title="3.GROUP BY优化"></a>3.GROUP BY优化</h3><ul>
<li><code>GROUP BY</code>实质是先排序后进行分组，遵照索引建的最佳左前缀。 </li>
<li>当无法使用索引列时，会使用<code>Using filesort</code>进行排序，增大<code>max_length_for_sort_data</code>参数的设置和增大<code>sort_buffer_size</code>参数的设置，会提高性能。 </li>
<li><code>WHERE</code>执行顺序高于<code>HAVING</code>，能写在<code>WHERE</code>限定条件里的就不要写在<code>HAVING</code>中了。 </li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><strong>为排序使用索引</strong></p>
<ul>
<li>MySQL两种排序方式：<code>Using filesort</code>和<code>Using Index</code>扫描有序索引排序。</li>
<li>MySQL能为排序与查询使用相同的索引，创建的索引可以用于排序也可以用于查询</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs mysql">&#x2F;* 创建a b c三个字段的索引 *&#x2F;<br>idx_table_a_b_c(a, b, c)<br><br>&#x2F;* 1.ORDER BY 能使用索引最左前缀 *&#x2F;<br>ORDER BY a;<br>ORDER BY a, b;<br>ORDER BY a, b, c;<br>ORDER BY a DESC, b DESC, c DESC;<br><br>&#x2F;* 2.如果WHERE子句中使用索引的最左前缀定义为常量，则ORDER BY能使用索引 *&#x2F;<br>WHERE a &#x3D; &#39;Ringo&#39; ORDER BY b, c;<br>WHERE a &#x3D; &#39;Ringo&#39; AND b &#x3D; &#39;Tangs&#39; ORDER BY c;<br>WHERE a &#x3D; &#39;Ringo&#39; AND b &gt; 2000 ORDER BY b, c;<br><br>&#x2F;* 3.不能使用索引进行排序 *&#x2F;<br>ORDER BY a ASC, b DESC, c DESC;  &#x2F;* 排序不一致 *&#x2F;<br>WHERE g &#x3D; const ORDER BY b, c;   &#x2F;* 丢失a字段索引 *&#x2F;<br>WHERE a &#x3D; const ORDER BY c;      &#x2F;* 丢失b字段索引 *&#x2F;<br>WHERE a &#x3D; const ORDER BY a, d;   &#x2F;* d字段不是索引的一部分 *&#x2F;<br>WHERE a IN (...) ORDER BY b, c;  &#x2F;* 对于排序来说，多个相等条件(a&#x3D;1 or a&#x3D;2)也是范围查询 *&#x2F;<br></code></pre></td></tr></table></figure>

<h2 id="慢查询日志"><a href="#慢查询日志" class="headerlink" title="慢查询日志"></a>慢查询日志</h2><h3 id="慢查询日志介绍"><a href="#慢查询日志介绍" class="headerlink" title="慢查询日志介绍"></a>慢查询日志介绍</h3><p><strong>慢查询日志是什么</strong>？</p>
<ul>
<li>MySQL的慢查询日志是MySQL提供的一种日志记录，它用来记录在MySQL中响应时间超过阈值的语句，具体指运行时间超过 <code>long_query_time</code> 值的SQL，则会被记录到慢查询日志中。</li>
<li><code>long_query_time</code> 的默认值为10，意思是运行10秒以上的语句。</li>
<li>由慢查询日志来查看哪些SQL超出了我们的最大忍耐时间值，比如一条SQL执行超过5秒钟，我们就算慢SQL，希望能收集超过5秒钟的SQL，结合之前 <code>explain</code> 进行全面分析。</li>
</ul>
<p>特别说明</p>
<p>​    <strong>默认情况下，MySQL数据库没有开启慢查询日志，</strong>需要我们手动来设置这个参数。</p>
<p>​    <strong>当然，如果不是调优需要的话，一般不建议启动该参数</strong>，因为开启慢查询日志会或多或少带来一定的性能影响。慢查询日志支持将日志记录写入文件。</p>
<p><strong>查看慢查询日志是否开以及如何开启</strong></p>
<ul>
<li>查看慢查询日志是否开启：<code>SHOW VARIABLES LIKE &#39;%slow_query_log%&#39;;</code></li>
<li>开启慢查询日志：<code>**SET GLOBAL slow_query_log = 1;**</code>。<strong>使用该方法开启MySQL的慢查询日志只对当前数据库生效，如果MySQL重启后会失效。</strong> </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># 1、查看慢查询日志是否开启<br>mysql&gt; SHOW VARIABLES LIKE &#39;%slow_query_log%&#39;;<br>+---------------------+---------------------------------------+<br>| Variable_name       | Value                                 |<br>+---------------------+---------------------------------------+<br>| slow_query_log      | OFF                                   |<br>| slow_query_log_file | &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;cess-Ubuntu20-slow.log |<br>+---------------------+---------------------------------------+<br>2 rows in set (0.01 sec)<br><br># 2、开启慢查询日志<br>mysql&gt; SET GLOBAL slow_query_log &#x3D; 1;<br>Query OK, 0 rows affected (0.00 sec)<br></code></pre></td></tr></table></figure>

<p>修改<code>long_query_time</code>的时间，需要在<code>my.cnf</code>修改配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">[mysqld]<br># 这个是设置慢查询的时间，我设置的为1秒<br>long_query_time&#x3D;1<br></code></pre></td></tr></table></figure>

<p>修改后需要重新连接或新开一个会话才能看到修改值</p>
<p>查新慢查询日志的总记录条数：<code>SHOW GLOBAL STATUS LIKE &#39;%Slow_queries%&#39;;</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">mysql&gt;</span><span class="bash"> select sleep(4);</span><br>+----------+<br>| sleep(4) |<br>+----------+<br>|        0 |<br>+----------+<br>1 row in set (4.00 sec)<br><br><span class="hljs-meta">mysql&gt;</span><span class="bash"> SHOW GLOBAL STATUS LIKE <span class="hljs-string">&#x27;%Slow_queries%&#x27;</span>;</span><br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| Slow_queries  | 1     |<br>+---------------+-------+<br>1 row in set (0.00 sec)<br></code></pre></td></tr></table></figure>

<p>打开cat /var/lib/mysql//var/lib/mysql/slow.log</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mysql">&#x2F;usr&#x2F;sbin&#x2F;mysqld, Version: 5.7.34 (MySQL Community Server (GPL)). started with:<br>Tcp port: 3306  Unix socket: &#x2F;var&#x2F;run&#x2F;mysqld&#x2F;mysqld.sock<br>Time                 Id Command    Argument<br># Time: 2021-10-27T14:03:33.201362Z<br># User@Host: root[root] @ DESKTOP-2JU9EV3.lan [192.168.199.132]  Id:    11<br># Query_time: 4.001308  Lock_time: 0.000000 Rows_sent: 1  Rows_examined: 0<br>use db01;<br>SET timestamp&#x3D;1635343413;<br>&#x2F;* ApplicationName&#x3D;IntelliJ IDEA 2021.1.2 *&#x2F; select sleep(4);<br></code></pre></td></tr></table></figure>

<h3 id="日志分析工具"><a href="#日志分析工具" class="headerlink" title="日志分析工具"></a>日志分析工具</h3><p>日志分析工具 <code>mysqldumpslow</code>：在生产环境中，如果要手工分析日志，查找、分析SQL，显然是个体力活，MySQL提供了日志分析工具 <code>mysqldumpslow</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 1、mysqldumpslow --<span class="hljs-built_in">help</span> 来查看mysqldumpslow的帮助信息</span><br>root@1dcb5644392c:/usr/bin# mysqldumpslow --help<br>Usage: mysqldumpslow [ OPTS... ] [ LOGS... ]<br><br>Parse and summarize the MySQL slow query log. Options are<br><br>  --verbose    verbose<br>  --debug      debug<br>  --help       write this text to standard output<br><br>  -v           verbose<br>  -d           debug<br>  -s ORDER     what to sort by (al, at, ar, c, l, r, t), &#x27;at&#x27; is default  # 按照何种方式排序<br>                al: average lock time		# 平均锁定时间<br>                ar: average rows sent		# 平均返回记录数<br>                at: average query time	# 平均查询时间<br>                 c: count  # 访问次数<br>                 l: lock time						# 锁定时间<br>                 r: rows sent						# 返回记录<br>                 t: query time					# 查询时间 <br>  -r           reverse the sort order (largest last instead of first)<br>  -t NUM       just show the top n queries  # 返回前面多少条记录<br>  -a           don&#x27;t abstract all numbers to N and strings to &#x27;S&#x27;<br>  -n NUM       abstract numbers with at least n digits within names<br>  -g PATTERN   grep: only consider stmts that include this string  <br>  -h HOSTNAME  hostname of db server for *-slow.log filename (can be wildcard),<br>               default is &#x27;*&#x27;, i.e. match all<br>  -i NAME      name of server instance (if using mysql.server startup script)<br>  -l           don&#x27;t subtract lock time from total time<br>  <br><span class="hljs-meta">#</span><span class="bash"> 2、 案例</span><br><span class="hljs-meta">#</span><span class="bash"> 2.1、得到返回记录集最多的10个SQL</span><br>mysqldumpslow -s r -t 10 /var/lib/mysql/slow.log<br> <br><span class="hljs-meta">#</span><span class="bash"> 2.2、得到访问次数最多的10个SQL</span><br>mysqldumpslow -s c -t 10 /var/lib/mysql/slow.log<br> <br><span class="hljs-meta">#</span><span class="bash"> 2.3、得到按照时间排序的前10条里面含有左连接的查询语句</span><br>mysqldumpslow -s t -t 10 -g &quot;left join&quot; /var/lib/mysql/slow.log<br><br><span class="hljs-meta">#</span><span class="bash"> 2.4、另外建议使用这些命令时结合|和more使用，否则出现爆屏的情况</span><br>mysqldumpslow -s r -t 10 /var/lib/mysql/slow.log | more<br></code></pre></td></tr></table></figure>

<h2 id="批量插入数据脚本"><a href="#批量插入数据脚本" class="headerlink" title="批量插入数据脚本"></a>批量插入数据脚本</h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><ol>
<li>建表SQL</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs mysql">&#x2F;* 1.dept表 *&#x2F;<br>CREATE TABLE &#96;dept&#96; (<br>  &#96;id&#96; int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT &#39;主键&#39;,<br>  &#96;deptno&#96; int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;部门id&#39;,<br>  &#96;dname&#96; varchar(20) NOT NULL DEFAULT &#39;&#39; COMMENT &#39;部门名字&#39;,<br>  &#96;loc&#96; varchar(13) NOT NULL DEFAULT &#39;&#39; COMMENT &#39;部门地址&#39;,<br>  PRIMARY KEY (&#96;id&#96;)<br>) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8 COMMENT&#x3D;&#39;部门表&#39;<br><br>&#x2F;* 2.emp表 *&#x2F;<br>CREATE TABLE &#96;emp&#96; (<br>  &#96;id&#96; int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT &#39;主键&#39;,<br>  &#96;empno&#96; int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;员工编号&#39;,<br>  &#96;ename&#96; varchar(20) NOT NULL DEFAULT &#39;&#39; COMMENT &#39;员工名字&#39;,<br>  &#96;job&#96; varchar(9) NOT NULL DEFAULT &#39;&#39; COMMENT &#39;职位&#39;,<br>  &#96;mgr&#96; int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;上级编号&#39;,<br>  &#96;hiredata&#96; date NOT NULL COMMENT &#39;入职时间&#39;,<br>  &#96;sal&#96; decimal(7,2) NOT NULL COMMENT &#39;薪水&#39;,<br>  &#96;comm&#96; decimal(7,2) NOT NULL COMMENT &#39;分红&#39;,<br>  &#96;deptno&#96; int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;部门id&#39;,<br>  PRIMARY KEY (&#96;id&#96;)<br>) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8 COMMENT&#x3D;&#39;员工表&#39;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>由于开启过慢查询日志，开启了<code>bin-log</code>，我们就必须为<code>function</code>指定一个参数，否则使用函数会报错。</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 在mysql中设置</span> <br><span class="hljs-meta">#</span><span class="bash"> log_bin_trust_function_creators 默认是关闭的 需要手动开启</span><br><span class="hljs-meta">mysql&gt;</span><span class="bash"> SHOW VARIABLES LIKE <span class="hljs-string">&#x27;log_bin_trust_function_creators&#x27;</span>;</span><br>+---------------------------------+-------+<br>| Variable_name                   | Value |<br>+---------------------------------+-------+<br>| log_bin_trust_function_creators | OFF   |<br>+---------------------------------+-------+<br>1 row in set (0.00 sec)<br><br><span class="hljs-meta">mysql&gt;</span><span class="bash"> SET GLOBAL log_bin_trust_function_creators=1;</span><br>Query OK, 0 rows affected (0.00 sec)<br></code></pre></td></tr></table></figure>

<p>上述修改方式MySQL重启后会失败，在<code>my.cnf</code>配置文件下修改永久有效。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[mysqld]<br>log_bin_trust_function_creators=ON<br></code></pre></td></tr></table></figure>

<h3 id="创建函数"><a href="#创建函数" class="headerlink" title="创建函数"></a>创建函数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># 1、函数：随机产生字符串<br>DELIMITER $$<br>CREATE FUNCTION rand_string(n INT) RETURNS VARCHAR(255)<br>BEGIN<br>    DECLARE chars_str VARCHAR(100) DEFAULT &#39;abcdefghijklmnopqrstuvwsyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;;<br>    DECLARE return_str VARCHAR(255) DEFAULT &#39;&#39;;<br>    DECLARE i INT DEFAULT 0;<br>    WHILE i &lt; n DO<br>    SET return_str &#x3D; CONCAT(return_str,SUBSTRING(chars_str,FLOOR(1+RAND()*52),1));<br>    SET i &#x3D; i + 1;<br>    END WHILE;<br>    RETURN return_str;<br>END $$<br><br># 2、函数：随机产生部门编号<br>DELIMITER $$<br>CREATE FUNCTION rand_num() RETURNS INT(5)<br>BEGIN<br>    DECLARE i INT DEFAULT 0;<br>    SET i &#x3D; FLOOR(100 + RAND() * 10);<br>    RETURN i;<br>END $$<br></code></pre></td></tr></table></figure>

<h3 id="创建存储过程"><a href="#创建存储过程" class="headerlink" title="创建存储过程"></a>创建存储过程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># 1、函数：向dept表批量插入<br>DELIMITER $$<br>CREATE PROCEDURE insert_dept(IN START INT(10),IN max_num INT(10))<br>BEGIN<br>DECLARE i INT DEFAULT 0;<br>    SET autocommit &#x3D; 0;<br>    REPEAT<br>    SET i &#x3D; i + 1;<br>    INSERT INTO dept(deptno,dname,loc) VALUES((START + i),rand_string(10),rand_string(8));<br>    UNTIL i &#x3D; max_num<br>    END REPEAT;<br>    COMMIT;<br>END $$<br><br># 2、函数：向emp表批量插入<br>DELIMITER $$<br>CREATE PROCEDURE insert_emp(IN START INT(10),IN max_num INT(10))<br>BEGIN<br>DECLARE i INT DEFAULT 0;<br>    SET autocommit &#x3D; 0;<br>    REPEAT<br>    SET i &#x3D; i + 1;<br>    INSERT INTO emp(empno,ename,job,mgr,hiredata,sal,comm,deptno) VALUES((START + i),rand_string(6),&#39;SALESMAN&#39;,0001,CURDATE(),2000,400,rand_num());<br>    UNTIL i &#x3D; max_num<br>    END REPEAT;<br>    COMMIT;<br>END $$<br></code></pre></td></tr></table></figure>

<h3 id="调用存储过程"><a href="#调用存储过程" class="headerlink" title="调用存储过程"></a>调用存储过程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># 1、调用存储过程向dept表插入10个部门。<br>DELIMITER ;<br>CALL insert_dept(100,10);<br><br># 2、调用存储过程向emp表插入50万条数据。<br>DELIMITER ;<br>CALL insert_emp(100001,500000);<br></code></pre></td></tr></table></figure>

<h2 id="Show-Profile"><a href="#Show-Profile" class="headerlink" title="Show Profile"></a>Show Profile</h2><p><strong>Show Profile</strong></p>
<p>MySQL提供可以用来分析当前会话中语句执行的资源消耗情况。</p>
<p>可以用于SQL的调优的测量。<strong>默认情况下，参数处于关闭状态，并保存最近15次的运行结果。</strong></p>
<p><strong>分析步骤</strong></p>
<ol>
<li>是否支持，查看当前的MySQL版本是否支持</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 查看Show Profile功能是否开启</span><br><span class="hljs-meta">mysql&gt;</span><span class="bash"> SHOW VARIABLES LIKE <span class="hljs-string">&#x27;profiling&#x27;</span>;</span><br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| profiling     | OFF   |<br>+---------------+-------+<br>1 row in set (0.00 sec)<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>开启<code>Show Profile</code>功能，默认是关闭的，使用前需要开启。</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 开启Show Profile功能</span><br><span class="hljs-meta">mysql&gt;</span><span class="bash"> SET profiling=ON;</span><br>Query OK, 0 rows affected, 1 warning (0.00 sec)<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>运行SQL</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT * FROM &#96;emp&#96; GROUP BY &#96;id&#96;%10 LIMIT 150000;<br><br>SELECT * FROM &#96;emp&#96; GROUP BY &#96;id&#96;%20 ORDER BY 5;<br></code></pre></td></tr></table></figure>

<ol start="4">
<li>查看结果，执行SHOW PROFILES</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">mysql&gt;</span><span class="bash"> SHOW PROFILES;</span><br>+----------+------------+---------------------------------------------------+<br>| Query_ID | Duration   | Query                                             |<br>+----------+------------+---------------------------------------------------+<br>|        1 | 0.00156100 | SHOW VARIABLES LIKE &#x27;profiling&#x27;                   |<br>|        2 | 0.56296725 | SELECT * FROM `emp` GROUP BY `id`%10 LIMIT 150000 |<br>|        3 | 0.52105825 | SELECT * FROM `emp` GROUP BY `id`%10 LIMIT 150000 |<br>|        4 | 0.51279775 | SELECT * FROM `emp` GROUP BY `id`%20 ORDER BY 5   |<br>+----------+------------+---------------------------------------------------+<br>4 rows in set, 1 warning (0.00 sec)<br></code></pre></td></tr></table></figure>

<ol start="5">
<li>诊断SQL，<code>SHOW PROFILE cpu,block io FOR QUERY Query_ID;</code></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 这里的3是第四步中的Query_ID。</span><br><span class="hljs-meta">#</span><span class="bash"> 可以在SHOW PROFILE中看到一条SQL中完整的生命周期。</span><br><span class="hljs-meta">mysql&gt;</span><span class="bash"> SHOW PROFILE cpu,block io FOR QUERY 3;</span><br>+----------------------+----------+----------+------------+--------------+---------------+<br>| Status               | Duration | CPU_user | CPU_system | Block_ops_in | Block_ops_out |<br>+----------------------+----------+----------+------------+--------------+---------------+<br>| starting             | 0.000097 | 0.000090 |   0.000002 |            0 |             0 |<br>| checking permissions | 0.000010 | 0.000009 |   0.000000 |            0 |             0 |<br>| Opening tables       | 0.000039 | 0.000058 |   0.000000 |            0 |             0 |<br>| init                 | 0.000046 | 0.000046 |   0.000000 |            0 |             0 |<br>| System lock          | 0.000011 | 0.000000 |   0.000000 |            0 |             0 |<br>| optimizing           | 0.000005 | 0.000000 |   0.000000 |            0 |             0 |<br>| statistics           | 0.000023 | 0.000037 |   0.000000 |            0 |             0 |<br>| preparing            | 0.000014 | 0.000000 |   0.000000 |            0 |             0 |<br>| Creating tmp table   | 0.000041 | 0.000053 |   0.000000 |            0 |             0 |<br>| Sorting result       | 0.000005 | 0.000000 |   0.000000 |            0 |             0 |<br>| executing            | 0.000003 | 0.000000 |   0.000000 |            0 |             0 |<br>| Sending data         | 0.520620 | 0.516267 |   0.000000 |            0 |             0 |<br>| Creating sort index  | 0.000060 | 0.000051 |   0.000000 |            0 |             0 |<br>| end                  | 0.000006 | 0.000000 |   0.000000 |            0 |             0 |<br>| query end            | 0.000011 | 0.000000 |   0.000000 |            0 |             0 |<br>| removing tmp table   | 0.000006 | 0.000000 |   0.000000 |            0 |             0 |<br>| query end            | 0.000004 | 0.000000 |   0.000000 |            0 |             0 |<br>| closing tables       | 0.000009 | 0.000000 |   0.000000 |            0 |             0 |<br>| freeing items        | 0.000032 | 0.000064 |   0.000000 |            0 |             0 |<br>| cleaning up          | 0.000019 | 0.000000 |   0.000000 |            0 |             0 |<br>+----------------------+----------+----------+------------+--------------+---------------+<br>20 rows in set, 1 warning (0.00 sec)<br></code></pre></td></tr></table></figure>

<p><code>Show Profile</code>查询参数备注：</p>
<ul>
<li><code>ALL</code>：显示所有的开销信息。</li>
<li><code>BLOCK IO</code>：显示块IO相关开销（通用）</li>
<li><code>CONTEXT SWITCHES</code>：上下文切换相关开销。</li>
<li><code>CPU</code>：显示CPU相关开销信息（通用）。</li>
<li><code>IPC</code>：显示发送和接收相关开销信息。</li>
<li><code>MEMORY</code>：显示内存相关开销信息。</li>
<li><code>PAGE FAULTS</code>：显示页面错误相关开销信息。</li>
<li><code>SOURCE</code>：显示和Source_function。</li>
<li><code>SWAPS</code>：显示交换次数相关开销的信息。</li>
</ul>
<ol start="6">
<li><code>Show Profile</code>查询列表，日常开发需要注意的结论：</li>
</ol>
<ul>
<li><code>converting HEAP to MyISAM</code>：查询结果太大，内存都不够用了，往磁盘上搬了。</li>
<li><code>Creating tmp table</code>：创建临时表（拷贝数据到临时表，用完再删除），非常耗费数据库性能。</li>
<li><code>Copying to tmp table on disk</code>：把内存中的临时表复制到磁盘，危险！！！</li>
<li><code>locked</code>：死锁。</li>
</ul>
<h2 id="全局查询日志"><a href="#全局查询日志" class="headerlink" title="全局查询日志"></a>全局查询日志</h2><p>只在测试环境下才可以使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mysql">在mysql的my.cnf中，设置如下<br>#开启<br>general_log&#x3D;1<br><br>#记录日志文件的路径<br>general_log_file&#x3D;&#x2F;path&#x2F;logfile<br><br>#输出格式<br>log_output&#x3D;FILE<br></code></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">set global general_log&#x3D;1;<br>set global log_output&#x3D;&#39;TABLE&#39;;<br><br>#此后编写的sql语句，将会记录到mysql库里的general_log表，可以用下面的命令查看<br>select * from mysql.general_log;<br></code></pre></td></tr></table></figure>

<h2 id="表行锁"><a href="#表行锁" class="headerlink" title="表行锁"></a>表行锁</h2><h3 id="表锁（偏读）"><a href="#表锁（偏读）" class="headerlink" title="表锁（偏读）"></a>表锁（偏读）</h3><p><strong>表锁特点</strong></p>
<ul>
<li>表锁偏向<code>MyISAM</code> 存储引擎，开销小，加锁快，无死锁，锁定粒度大，发生锁冲突的概率最高，并发度最低</li>
</ul>
<h4 id="环境准备-1"><a href="#环境准备-1" class="headerlink" title="环境准备"></a>环境准备</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># 1、创建表<br>CREATE TABLE &#96;mylock&#96;(<br>&#96;id&#96; INT NOT NULL PRIMARY KEY AUTO_INCREMENT,<br>&#96;name&#96; VARCHAR(20)<br>)ENGINE&#x3D;MYISAM DEFAULT CHARSET&#x3D;utf8 COMMENT&#x3D;&#39;测试表锁&#39;;<br><br># 2、插入数据<br>INSERT INTO &#96;mylock&#96;(&#96;name&#96;) VALUES(&#39;ZhangSan&#39;);<br>INSERT INTO &#96;mylock&#96;(&#96;name&#96;) VALUES(&#39;LiSi&#39;);<br>INSERT INTO &#96;mylock&#96;(&#96;name&#96;) VALUES(&#39;WangWu&#39;);<br>INSERT INTO &#96;mylock&#96;(&#96;name&#96;) VALUES(&#39;ZhaoLiu&#39;);<br></code></pre></td></tr></table></figure>

<h4 id="锁表的命令"><a href="#锁表的命令" class="headerlink" title="锁表的命令"></a>锁表的命令</h4><ol>
<li>查看数据库表锁的命令</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># 查看数据库表锁的命令<br>SHOW OPEN TABLES;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>给<code>mylock</code>表上读锁，给<code>book</code>表上写锁</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># 给mylock表上读锁，给book表上写锁<br>LOCK TABLES &#96;mylock&#96; READ, &#96;book&#96; WRITE;<br><br># 查看当前表的状态<br>mysql&gt; SHOW OPEN TABLES;<br>+--------------------+-------------------------+--------+-------------+<br>| Database           | Table                   | In_use | Name_locked |<br>+--------------------+-------------------------+--------+-------------+<br>| sql_analysis       | book                    |      1 |           0 |<br>| sql_analysis       | mylock                  |      1 |           0 |<br>+--------------------+-------------------------+--------+-------------+<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>释放表锁</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># 释放给表添加的锁<br>UNLOCK TABLES;<br><br># 查看当前表的状态<br>mysql&gt; SHOW OPEN TABLES;<br>+--------------------+-------------------------+--------+-------------+<br>| Database           | Table                   | In_use | Name_locked |<br>+--------------------+-------------------------+--------+-------------+<br>| sql_analysis       | book                    |      0 |           0 |<br>| sql_analysis       | mylock                  |      0 |           0 |<br>+--------------------+-------------------------+--------+-------------+<br></code></pre></td></tr></table></figure>

<h4 id="读锁案例"><a href="#读锁案例" class="headerlink" title="读锁案例"></a>读锁案例</h4><ol>
<li>打开两个会话，<code>SESSION1</code>为<code>mylock</code>表添加读锁。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># 为mylock表添加读锁<br>LOCK TABLES &#96;mylock&#96; READ;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li><p>打开两个会话，<code>SESSION1</code>是否可以读自己锁的表？是否可以修改自己锁的表？是否可以读其他的表？那么<code>SESSION2</code>呢？</p>
<p>SESSION1 能 不能 不能</p>
<p>SESSION2 能 阻塞 能</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># SESSION1<br><br># 问题1：SESSION1为mylock表加了读锁，可以读mylock表！<br>mysql&gt; SELECT * FROM &#96;mylock&#96;;<br>+----+----------+<br>| id | name     |<br>+----+----------+<br>|  1 | ZhangSan |<br>|  2 | LiSi     |<br>|  3 | WangWu   |<br>|  4 | ZhaoLiu  |<br>+----+----------+<br>4 rows in set (0.00 sec)<br><br># 问题2：SESSION1为mylock表加了读锁，不可以修改mylock表！<br>mysql&gt; UPDATE mylock SET name &#x3D; &#39;abc&#39; WHERE id &#x3D; 1;<br>ERROR 1099 (HY000): Table mylock was locked with a READ lock and cannot be updated<br><br># 问题3：SESSION1为mylock表加了读锁，不可以读其他的表！<br>mysql&gt; SELECT * FROM &#96;book&#96;;<br>ERROR 1100 (HY000): Table &#39;book&#39; was not locked with LOCK TABLES<br></code></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># SESSION2<br><br># 问题1：SESSION1为mylock表加了读锁，SESSION2可以读mylock表！<br>mysql&gt; SELECT * FROM &#96;mylock&#96;;<br>+----+----------+<br>| id | name     |<br>+----+----------+<br>|  1 | ZhangSan |<br>|  2 | LiSi     |<br>|  3 | WangWu   |<br>|  4 | ZhaoLiu  |<br>+----+----------+<br>4 rows in set (0.00 sec)<br><br># 问题2：SESSION1为mylock表加了读锁，SESSION2修改mylock表会被阻塞，<br>#        需要等待SESSION1释放mylock表！<br>mysql&gt; UPDATE &#96;mylock&#96; SET &#96;name&#96; &#x3D; &#39;abc&#39; WHERE &#96;id&#96; &#x3D; 1;<br>^C^C -- query aborted<br>ERROR 1317 (70100): Query execution was interrupted<br><br># 问题3：SESSION1为mylock表加了读锁，SESSION2可以读其他表！<br>mysql&gt; SELECT * FROM &#96;book&#96;;<br>+--------+------+<br>| bookid | card |<br>+--------+------+<br>|      1 |    1 |<br>|      7 |    4 |<br>|      8 |    4 |<br>|      9 |    5 |<br>|      5 |    6 |<br>|     17 |    6 |<br>|     15 |    8 |<br>+--------+------+<br>24 rows in set (0.00 sec)<br></code></pre></td></tr></table></figure>

<h4 id="写锁案例"><a href="#写锁案例" class="headerlink" title="写锁案例"></a>写锁案例</h4><ol>
<li>打开两个会话，<code>SESSION1</code>为<code>mylock</code>表添加写锁。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># 为mylock表添加写锁<br>LOCK TABLES mylock WRITE;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li><p>打开两个会话，<code>SESSION1</code>是否可以读自己锁的表？是否可以修改自己锁的表？是否可以读其他的表？那么<code>SESSION2</code>呢？</p>
<p>SESSION1 能 能 不能</p>
<p>SESSION2 阻塞 阻塞 能</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># SESSION1<br><br># 问题1：SESSION1为mylock表加了写锁，可以读mylock的表！<br>mysql&gt; SELECT * FROM &#96;mylock&#96;;<br>+----+----------+<br>| id | name     |<br>+----+----------+<br>|  1 | ZhangSan |<br>|  2 | LiSi     |<br>|  3 | WangWu   |<br>|  4 | ZhaoLiu  |<br>+----+----------+<br>4 rows in set (0.00 sec)<br><br># 问题2：SESSION1为mylock表加了写锁，可以修改mylock表!<br>mysql&gt; UPDATE &#96;mylock&#96; SET &#96;name&#96; &#x3D; &#39;abc&#39; WHERE &#96;id&#96; &#x3D; 1;<br>Query OK, 1 row affected (0.00 sec)<br>Rows matched: 1  Changed: 1  Warnings: 0<br><br># 问题3：SESSION1为mylock表加了写锁，不能读其他表!<br>mysql&gt; SELECT * FROM &#96;book&#96;;<br>ERROR 1100 (HY000): Table &#39;book&#39; was not locked with LOCK TABLES<br><br># SESSION2<br><br># 问题1：SESSION1为mylock表加了写锁，SESSION2读mylock表会阻塞，等待SESSION1释放！<br>mysql&gt; SELECT * FROM &#96;mylock&#96;;<br>^C^C -- query aborted<br>ERROR 1317 (70100): Query execution was interrupted<br><br># 问题2：SESSION1为mylock表加了写锁，SESSION2读mylock表会阻塞，等待SESSION1释放！<br>mysql&gt; UPDATE &#96;mylock&#96; SET &#96;name&#96; &#x3D; &#39;abc&#39; WHERE &#96;id&#96; &#x3D; 1;<br>^C^C -- query aborted<br>ERROR 1317 (70100): Query execution was interrupted<br><br># 问题3：SESSION1为mylock表加了写锁，SESSION2可以读其他表！<br>mysql&gt; SELECT * FROM &#96;book&#96;;<br>+--------+------+<br>| bookid | card |<br>+--------+------+<br>|      1 |    1 |<br>|      7 |    4 |<br>|      8 |    4 |<br>|      9 |    5 |<br>|      5 |    6 |<br>|     17 |    6 |<br>|     15 |    8 |<br>+--------+------+<br>24 rows in set (0.00 sec)<br></code></pre></td></tr></table></figure>

<h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><p>**<code>MyISAM</code>引擎在执行查询语句<code>SELECT</code>之前，会自动给涉及到的所有表加读锁，在执行增删改之前，会自动给涉及的表加写锁 **</p>
<p>MySQL的表级锁带有两种模式</p>
<ul>
<li>表共享读锁（Table Read Lock）</li>
<li>表独占写锁（Table Write Lock）</li>
</ul>
<p>对<code>MyISAM</code>表进行操作，会有一下情况</p>
<ul>
<li>对<code>MyISAM</code>表的读操作（加读锁），不会阻塞其他线程对同一表的读操作，但是会阻塞其他线程对同一表的写操作。只有当读锁释放之后，才会执行其他线程的写操作</li>
<li>对<code>MyISAM</code>表的写操作（加写锁），会阻塞其他线程对同一表的读和写操作，只有当写锁释放之后，才会执行其他线程的读写操作</li>
<li><strong>简言之，就是读锁会阻塞写，但不会阻塞读。而写锁会把读跟写都阻塞。</strong></li>
</ul>
<h3 id="行锁（偏写）"><a href="#行锁（偏写）" class="headerlink" title="行锁（偏写）"></a>行锁（偏写）</h3><p><strong>行锁特点</strong></p>
<ul>
<li>偏向<code>InnoDB</code>存储引擎，开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低，并发度最高。</li>
</ul>
<p><strong><code>InnoDB</code>存储引擎和<code>MyISAM</code>存储引擎最大不同有两点：一是支持事务，而是采用行锁</strong></p>
<h4 id="环境准备-2"><a href="#环境准备-2" class="headerlink" title="环境准备"></a>环境准备</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># 建表语句<br>CREATE TABLE &#96;test_innodb_lock&#96;(<br>&#96;a&#96; INT,<br>&#96;b&#96; VARCHAR(16)<br>)ENGINE&#x3D;INNODB DEFAULT CHARSET&#x3D;utf8 COMMENT&#x3D;&#39;测试行锁&#39;; <br><br># 插入数据<br>INSERT INTO &#96;test_innodb_lock&#96;(&#96;a&#96;, &#96;b&#96;) VALUES(1, &#39;b2&#39;);<br>INSERT INTO &#96;test_innodb_lock&#96;(&#96;a&#96;, &#96;b&#96;) VALUES(2, &#39;3&#39;);<br>INSERT INTO &#96;test_innodb_lock&#96;(&#96;a&#96;, &#96;b&#96;) VALUES(3, &#39;4000&#39;);<br>INSERT INTO &#96;test_innodb_lock&#96;(&#96;a&#96;, &#96;b&#96;) VALUES(4, &#39;5000&#39;);<br>INSERT INTO &#96;test_innodb_lock&#96;(&#96;a&#96;, &#96;b&#96;) VALUES(5, &#39;6000&#39;);<br>INSERT INTO &#96;test_innodb_lock&#96;(&#96;a&#96;, &#96;b&#96;) VALUES(6, &#39;7000&#39;);<br>INSERT INTO &#96;test_innodb_lock&#96;(&#96;a&#96;, &#96;b&#96;) VALUES(7, &#39;8000&#39;);<br>INSERT INTO &#96;test_innodb_lock&#96;(&#96;a&#96;, &#96;b&#96;) VALUES(8, &#39;9000&#39;);<br><br># 创建索引<br>CREATE INDEX idx_test_a ON &#96;test_innodb_lock&#96;(a);<br>CREATE INDEX idx_test_b ON &#96;test_innodb_lock&#96;(b);<br></code></pre></td></tr></table></figure>

<h4 id="行锁案例"><a href="#行锁案例" class="headerlink" title="行锁案例"></a>行锁案例</h4><ol>
<li>打开<code>SESSION1</code>和<code>SESSION2</code>两个会话，都开启手动提交</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># 开启MySQL数据库的手动提交<br>mysql&gt; SET autocommit&#x3D;0;<br>Query OK, 0 rows affected (0.00 sec)<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>读自己所写</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> SESSION1</span> <br><br><span class="hljs-meta">#</span><span class="bash"> SESSION1対test_innodb_lock表做写操作，但是没有commit。</span><br><span class="hljs-meta">#</span><span class="bash"> 执行修改SQL之后，查询一下test_innodb_lock表，发现数据被修改了。</span><br><span class="hljs-meta">mysql&gt;</span><span class="bash"> UPDATE `test_innodb_lock` SET `b` = <span class="hljs-string">&#x27;88&#x27;</span> WHERE `a` = 1;</span><br>Query OK, 1 row affected (0.00 sec)<br>Rows matched: 1  Changed: 1  Warnings: 0<br><br><span class="hljs-meta">mysql&gt;</span><span class="bash"> SELECT * FROM `test_innodb_lock`;</span><br>+------+------+<br>| a    | b    |<br>+------+------+<br>|    1 | 88   |<br>|    2 | 3    |<br>|    3 | 4000 |<br>|    4 | 5000 |<br>|    5 | 6000 |<br>|    6 | 7000 |<br>|    7 | 8000 |<br>|    8 | 9000 |<br>+------+------+<br>8 rows in set (0.00 sec)<br><br><span class="hljs-meta">#</span><span class="bash"> SESSION2</span> <br><br><span class="hljs-meta">#</span><span class="bash"> SESSION2这时候来查询test_innodb_lock表。</span><br><span class="hljs-meta">#</span><span class="bash"> 发现SESSION2是读不到SESSION1未提交的数据的。</span><br><span class="hljs-meta">mysql&gt;</span><span class="bash"> SELECT * FROM `test_innodb_lock`;</span><br>+------+------+<br>| a    | b    |<br>+------+------+<br>|    1 | b2   |<br>|    2 | 3    |<br>|    3 | 4000 |<br>|    4 | 5000 |<br>|    5 | 6000 |<br>|    6 | 7000 |<br>|    7 | 8000 |<br>|    8 | 9000 |<br>+------+------+<br>8 rows in set (0.00 se<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>行锁两个SESSION同时対一条记录进行写操作</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> SESSION1 対test_innodb_lock表的`a`=1这一行进行写操作，但是没有commit</span><br><span class="hljs-meta">mysql&gt;</span><span class="bash"> UPDATE `test_innodb_lock` SET `b` = <span class="hljs-string">&#x27;99&#x27;</span> WHERE `a` = 1;</span><br>Query OK, 1 row affected (0.00 sec)<br>Rows matched: 1  Changed: 1  Warnings: 0<br><br><span class="hljs-meta">#</span><span class="bash"> SESSION2 也对test_innodb_lock表的`a`=1这一行进行写操作，但是发现阻塞了！！！</span><br><span class="hljs-meta">#</span><span class="bash"> 等SESSION1执行commit语句之后，SESSION2的SQL就会执行了</span><br><span class="hljs-meta">mysql&gt;</span><span class="bash"> UPDATE `test_innodb_lock` SET `b` = <span class="hljs-string">&#x27;asdasd&#x27;</span> WHERE `a` = 1;</span><br>ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction<br><br><span class="hljs-meta">#</span><span class="bash"><span class="hljs-comment">#两边都需要提交</span></span><br></code></pre></td></tr></table></figure>

<ol start="4">
<li>行锁两个SESSION同时对不同记录进行写操作</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># SESSION1 対test_innodb_lock表的&#96;a&#96;&#x3D;6这一行进行写操作，但是没有commit<br>mysql&gt; UPDATE &#96;test_innodb_lock&#96; SET &#96;b&#96; &#x3D; &#39;8976&#39; WHERE &#96;a&#96; &#x3D; 6;<br>Query OK, 1 row affected (0.00 sec)<br>Rows matched: 1  Changed: 1  Warnings: 0<br><br># SESSION2 対test_innodb_lock表的&#96;a&#96;&#x3D;4这一行进行写操作，没有阻塞！！！<br># SESSION1和SESSION2同时对不同的行进行写操作互不影响<br>mysql&gt; UPDATE &#96;test_innodb_lock&#96; SET &#96;b&#96; &#x3D; &#39;Ringo&#39; WHERE &#96;a&#96; &#x3D; 4;<br>Query OK, 1 row affected (0.00 sec)<br>Rows matched: 1  Changed: 1  Warnings: 0<br></code></pre></td></tr></table></figure>

<h4 id="索引失效行锁变表锁"><a href="#索引失效行锁变表锁" class="headerlink" title="索引失效行锁变表锁"></a>索引失效行锁变表锁</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> SESSION1 执行SQL语句，没有执行commit。</span><br><span class="hljs-meta">#</span><span class="bash"> 由于`b`字段是字符串，但是没有加单引号导致索引失效</span><br><span class="hljs-meta">mysql&gt;</span><span class="bash"> UPDATE `test_innodb_lock` SET `a` = 888 WHERE `b` = 8000;</span><br>Query OK, 1 row affected, 1 warning (0.00 sec)<br>Rows matched: 1  Changed: 1  Warnings: 1<br><br><span class="hljs-meta">#</span><span class="bash"> SESSION2 和SESSION1操作的并不是同一行，但是也被阻塞了？？？</span><br><span class="hljs-meta">#</span><span class="bash"> 由于SESSION1执行的SQL索引失效，导致行锁升级为表锁。</span><br><span class="hljs-meta">mysql&gt;</span><span class="bash"> UPDATE `test_innodb_lock` SET `b` = <span class="hljs-string">&#x27;1314&#x27;</span> WHERE `a` = 1;</span><br>ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction<br></code></pre></td></tr></table></figure>

<h4 id="间隙锁的危害"><a href="#间隙锁的危害" class="headerlink" title="间隙锁的危害"></a>间隙锁的危害</h4><p><strong>什么是间隙锁</strong></p>
<p>​    当我们用范围条件而不是相等条件检索数据，并请求共享或者排他锁时，<code>InnoBD</code>会给符合条件的已有数据记录的索引项加锁，对于键值在条件范围内但并不存在的记录，叫做”间隙(GAP)”</p>
<p><strong>间隙锁的危害</strong></p>
<p>​    因为<code>Query</code>执行过程中通过范围查找的话，他会锁定整个范围内所有的索引键值，即使这个键值不存在。</p>
<p>​    间隙锁有一个比较致命的缺点，就是 <strong>当锁定一个范围的键值后，即使某些不存在的键值也会被无辜的锁定，而造成在锁定的适合无法插入锁定键值范围内的任何数据。</strong>在某些场景下这可能会对性能造成很大的危害</p>
<h4 id="如何锁定一行"><a href="#如何锁定一行" class="headerlink" title="如何锁定一行"></a>如何锁定一行</h4><p><img src="https://www.yuque.com/api/filetransfer/images?url=https://img-blog.csdnimg.cn/2020080616050355.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JyaW5nb18=,size_16,color_FFFFFF,t_70&sign=9e19c728edf85153f47bbd5faf52afe8666ca80f570ccb4705354810f6e79105" srcset="/img/loading.gif" lazyload></p>
<p><code>SELECT .....FOR UPDATE</code> 在锁定某一行后，其他写操作会被阻塞，直到锁定的行被COMMIT</p>
<p>mysql InnoDB引擎默认的修改数据语句，update，delete，insert都会自动给涉及到的数据加上排他锁，select语句默认不会加上任何锁类型，如果加排他锁可以使用select…for update语句，加共享锁可以使用select .. lock in share mode语句。所以加过排他锁的数据行在其他事务种是不能修改数据的，也不能通过for update 和 lock in share mode锁的方式查询数据，但可以直接通过select…from…查询数据，因为普通查询没有任何锁机制</p>
<p><img src="https://www.yuque.com/api/filetransfer/images?url=https://img-blog.csdnimg.cn/20210421122919994.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JyaW5nb18=,size_16,color_FFFFFF,t_70&sign=c6382767a8f34b5c4baa889585d11282bc623e96db096a491d74fafbb42cefde" srcset="/img/loading.gif" lazyload></p>
<h4 id="案例结论"><a href="#案例结论" class="headerlink" title="案例结论"></a>案例结论</h4><p><code>InnoDB</code>存储引擎由于实现了行级锁定，虽然在锁定机制的实现方面所带来的性能损耗可能比表级锁定会要更高一些，但是在整体并发处理能力方面要远远优于<code>MyISAM</code>的表级锁定的。当系统并发量较高的时候，<code>InnoDB</code>的整体性能和<code>MyISAM</code>相比就会有比较明显的优势了</p>
<p>但是，<code>InnoDB</code>的行级锁定同样也有其脆弱的一面，当我们使用不当的时候，可能会让<code>InnoDB</code>的整体性能表现不仅不能比<code>MyISAM</code> 高，甚至可能会更差。</p>
<h4 id="行锁分析"><a href="#行锁分析" class="headerlink" title="行锁分析"></a>行锁分析</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">mysql&gt;</span><span class="bash"> SHOW STATUS LIKE <span class="hljs-string">&#x27;innodb_row_lock%&#x27;</span>;</span><br>+-------------------------------+--------+<br>| Variable_name                 | Value  |<br>+-------------------------------+--------+<br>| Innodb_row_lock_current_waits | 0      |<br>| Innodb_row_lock_time          | 124150 |<br>| Innodb_row_lock_time_avg      | 31037  |<br>| Innodb_row_lock_time_max      | 51004  |<br>| Innodb_row_lock_waits         | 4      |<br>+-------------------------------+--------+<br>5 rows in set (0.00 sec)<br></code></pre></td></tr></table></figure>

<p>对各个状态量的说明如下：</p>
<ul>
<li><code>Innodb_row_lock_current_waits</code>:当前正在等待锁定的数量</li>
<li><code>Innodb_row_lock_time</code>:从系统启动到现在锁定总时间长度（重要）</li>
<li><code>Innodb_row_lock_time_avg</code>：每次等待所花的平均时间（重要）</li>
<li><code>Innodb_row_lock_time_max</code>：从系统启动到现在等待最长的一次所花的时间</li>
<li><code>Innodb_row_lock_waits</code>：系统启动后到现在总共等待的次数（重要）</li>
</ul>
<p>尤其当等待次数很高，而且每次等待时长也不小的时候，我们就需要分析系统中为什么会有如此多的等待，然后根据分析结果着手指定优化策略。</p>
<h3 id="优化建议"><a href="#优化建议" class="headerlink" title="优化建议"></a>优化建议</h3><ul>
<li>尽可能让所有数据检索都通过索引来完成，避免无索引行锁升级为表锁</li>
<li>合理设计索引，计量缩小所的范围</li>
<li>尽可能较少检索条件，避免间隙锁</li>
<li>尽量控制事务大小，减少锁定资源量和时间长度</li>
<li>尽可能低级别事务隔离</li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/MySQL/">MySQL</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/MySQL/">MySQL</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/01/15/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E9%AB%98%E7%BA%A7-%EF%BC%88%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%EF%BC%89/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">MySQL数据库高级 - （主从复制）</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/01/11/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E9%AB%98%E7%BA%A7-%EF%BC%88%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%EF%BC%89/">
                        <span class="hidden-mobile">MySQL数据库高级 - （索引优化）</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.lazyComments('valine', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', function () {
        new Valine({
          el: "#valine",
          app_id: "99lfyqRg3CLazXoohVQjMwH3-gzGzoHsz",
          app_key: "qx9rFQuqjhuegpH6AwJ8B0eD",
          placeholder: "说点什么",
          path: window.location.pathname,
          avatar: "retro",
          meta: ["nick","mail","link"],
          pageSize: "10",
          lang: "zh-CN",
          highlight: false,
          recordIP: true,
          serverURLs: "",
        });
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the
    <a target="_blank" href="https://valine.js.org" rel="nofollow noopener noopener">comments powered by Valine.</a>
  </noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      $('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      $('#modalSearch').on('shown.bs.modal', function() {
        $('#local-search-input').focus();
      });
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
